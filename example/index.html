<!doctype html>
<html>

<head>
	<meta content="text/html; charset=UTF-8" http-equiv="content-type" />
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
	<script src="lib/bootstrap/js/bootstrap.min.js" crossorigin="anonymous"></script>
	<style>
		html,
		body {
			margin: 0;
			padding: 0;
		}

		#mycanvas_container {
			overflow: auto;
			text-align: center;
			height: 100%;
			position: relative;
			margin: auto;
			background-color: #eee;
		}
	</style>
</head>

<body>
	<div id="container" class="container text-left" style="max-width: 100%; max-height: 100%; overflow: hidden;">
		<div class="row" style="width: 100%; height:100%; overflow: hidden;">
			<div class="col-2" style="height:100%; overflow:auto;">
				<ul class="list-group" id="tmpl_container">
					<li class="list-group-item"><img src="templates/1.jpeg" class="img-thumbnail" data-tmplid="1"
							alt="..."></li>
					<li class="list-group-item"><img src="templates/2.jpeg" class="img-thumbnail" data-tmplid="2"
							alt="..."></li>
					<li class="list-group-item"><img src="templates/3.jpeg" class="img-thumbnail" data-tmplid="3"
							alt="..."></li>
					<li class="list-group-item"><img src="templates/4.jpeg" class="img-thumbnail" data-tmplid="4"
							alt="..."></li>
				</ul>
			</div>
			<div class="col-8" style="height:100%; overflow: hidden;">
				<div id="myeditor_container" style="height:100%; overflow:auto;background-color: #eee;">
					<img id="btn_zoomin" src="images/zoom_in.png" style="position: fixed; left: 60%; bottom: 10px; z-index:100;box-shadow: 0 0 10px 10px #fff; transform:scale(0.6);
					background-color: #fff;" />
					<img id="btn_zoomout" src="images/zoom_out.png" style="position: fixed; left: 65%; bottom: 10px; z-index:100;box-shadow: 0 0 10px 10px #fff; transform:scale(0.6);
					background-color: #fff;" />
				</div>
			</div>
			<div class="col-2" style="height:100%; overflow:auto;">
				<img id="previewImg" width="200" />
			</div>
		</div>
	</div>

</body>
<script type="module">
	import './lib/html-to-image.js';
	import JEditor from "../dist/index.esm.js";

	const container = document.getElementById('myeditor_container');
	container.style.height = window.innerHeight + 'px';

	// 默认支持的字体
	const fonts = {
        'Zcool Kuaile Regular': {
            label: 'Zcool Kuaile Regular',
            family: 'Zcool Kuaile Regular',
            url: 'fonts/zcool-kuaile-regular.woff2'
        }
    };

	const editor = new JEditor({
		fonts,
		data: {
			width: 800,
			height: 600,
		},
		// editable: false,
		style: {
			backgroundColor: '#fff',
			containerBackgroundColor: '#eee'
		}
	});

	container.appendChild(editor.view.dom);

	// 大小改变后居中, 并且显示全部
	editor.on('resize', function (size) {
		const scale = Math.min(this.view.dom.clientWidth / (this.width * 1.4), this.view.dom.clientHeight / (this.height * 1.4));
		if (scale < 1 && scale < this.transform.scaleX) {
			this.scale(scale);
		}
	});

	// 元素发生改变事件
	editor.on('elementChange', async (e) => {
		console.log(e);
		if(e.type === 'styleChange') {
    		// 字体发生改变，需要做check, 并加载字体生效
			if(e.data.name === 'fontFamily') {
				// 如果没有在默认支持的字体内，这里会返回false
				if(editor.fonts.check(e.data.value)) return;// 已经加载，则跳过
				const con = fonts[e.data.value];
				if(con) {
					const f = await editor.fonts.load(con.family, con.url);// 加载
					console.log('load font', e.data.value, f.status);
				}
			}
		}
	});

    //editor.fromJSON({"children":[{"children":[],"type":"image","data":{"x":300,"left":300,"y":400,"top":400,"width":100,"height":100,"rotation":0,"src":"https://pixijs.com/assets/bunny.png"},"style":{"bottom":"auto","display":"inline-block","height":100,"left":300,"margin":"0","overflow":"visible","padding":"0","position":"absolute","right":"auto","top":400,"transform":"rotateZ(0rad) scaleX(1) scaleY(1)","width":100,"zIndex":"0"},"transform":{"translateX":0,"translateY":0,"translateZ":0,"rotateX":0,"rotateY":0,"rotateZ":0,"scaleX":1,"scaleY":1,"scaleZ":1,"skewX":0,"skewY":0},"id":"a1acb6d480ad4f1b94cc47c04c8d5cd7"},{"children":[],"type":"text","data":{"x":300,"left":300,"y":100,"top":100,"width":461,"height":39,"rotation":0,"text":"Basic text, 中文测试, complete"},"style":{"bottom":"auto","color":"#004620","display":"inline-block","fontFamily":"Crosterian","fontSize":22,"fontStyle":"normal","fontWeight":"lighter","height":39,"left":300,"margin":"0","overflow":"visible","padding":"0","position":"absolute","right":"auto","textAlign":"left","top":100,"transform":"rotateZ(0rad) scaleX(1) scaleY(1)","width":461,"wordBreak":"keep-all","zIndex":"0"},"transform":{"translateX":0,"translateY":0,"translateZ":0,"rotateX":0,"rotateY":0,"rotateZ":0,"scaleX":1,"scaleY":1,"scaleZ":1,"skewX":0,"skewY":0},"id":"224601617ac14a89a786a8ecc8dcc77f"},{"children":[],"type":"image","data":{"x":100,"left":100,"y":200,"top":200,"width":400,"height":400,"rotation":1.0471975511965976,"src":"https://jtcospublic.ciccten.com/config-server/1703730310545220869/idcard_qrcode.png"},"style":{"bottom":"auto","display":"inline-block","height":400,"left":100,"margin":"0","overflow":"visible","padding":"0","position":"absolute","right":"auto","top":200,"transform":"rotateZ(0rad) scaleX(1) scaleY(1)","width":400,"zIndex":"0"},"transform":{"translateX":0,"translateY":0,"translateZ":0,"rotateX":0,"rotateY":0,"rotateZ":0,"scaleX":1,"scaleY":1,"scaleZ":1,"skewX":0,"skewY":0},"id":"9828932c46f740759dcedd170e0adb54"}],"type":"","data":{"x":198.5,"left":198.5,"y":252.5,"top":252.5,"width":600,"height":800},"style":{"backgroundColor":"#fffffff","backgroundImage":"https://jtcospublic.ciccten.com/public/image/bf.jpg","backgroundSize":"100% 100%","bottom":"auto","boxShadow":"0 0 10px 10px #ccc","display":"inline-block","height":800,"left":198.5,"margin":"0","overflow":"visible","padding":"0","position":"absolute","right":"auto","top":252.5,"transform":"rotateZ(0rad) scaleX(1) scaleY(1)","width":600,"zIndex":"0"},"transform":{"translateX":0,"translateY":0,"translateZ":0,"rotateX":0,"rotateY":0,"rotateZ":0,"scaleX":1,"scaleY":1,"scaleZ":1,"skewX":0,"skewY":0},"id":"f8390b94642049f494934be4052fcaf0"})

	/*loadTemplate(1, (tmpl) => {
		editor.fromJSON(tmpl);
	});*/
	const img = editor.createShape('image', {
		data: {
			height: "auto",
			left: 325.5,
			src: "https://jtcospublic.ciccten.com/config-server/1705561487067855645/1622830_gallery_landskape_mountains_nature_photo_icon.png",
			top: 78,
			width: "auto"
		}
	});
	editor.addChild(img);

	const txt = editor.createShape('text', {
		data: {
			height: "auto",
			left: 400,
			top: 200,
			width: "auto",
			text: '请输入文本'
		}
	});
	editor.addChild(txt);

	// 加载模板
	async function loadTemplate(id, cb) {
		const url = `templates/${id}.json`;
        const request = new XMLHttpRequest();//新建XMLHttpRequest对象
        request.onreadystatechange = function (e) { //状态发生变化时，函数被回调
            if (this.readyState === 4) { //成功完成
                //判断相应结果：
                if (this.status ===200) {
                    const tmpl = JSON.parse(this.responseText);
                    cb(tmpl);
                } else {
                    console.log(e);
                    alert('加载模板失败');
                }
            }
        }
        //发送请求：
        request.open('GET', url);
        request.send();
	}

	// 模板点击
	document.getElementById('tmpl_container').addEventListener('click', function (e) {
		if (e.target.nodeName === 'IMG') {
			const idAttr = e.target.attributes['data-tmplid'];
			if (idAttr && idAttr.value) {
				loadTemplate(idAttr.value, (tmpl) => {                    
		            editor.fromJSON(tmpl);
                });
			}
		}
	});


	// 放大缩小
	document.getElementById('btn_zoomin').onclick = function () {
		editor.scale(editor.transform.scaleX + 0.1);
	}
	document.getElementById('btn_zoomout').onclick = function () {
		editor.scale(editor.transform.scaleX - 0.1);
	}

	// 调整大小
	window.onresize = function () {
		//editor.resize();
	}

	const preview = document.getElementById('previewImg');
	async function createPreivew() {
		// https://github.com/bubkoo/html-to-image

		//const fontEmbedCss = await htmlToImage.getFontEmbedCSS(editor.target.dom);
		//html2Image.toSVG(element1, { fontEmbedCss });
		//console.log(fontEmbedCss);
        // 截图取target的dom节点，才是真的编辑渲染区域
		const img = await window.htmlToImage.toPng(editor.target.dom);
		preview.src = img;

		setTimeout(createPreivew, 10000);


	};
	setTimeout(createPreivew, 2000);

    window.editor = editor;
</script>

</html>